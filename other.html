<!-- other.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Other Services - E-constructor</title>
  <link rel="stylesheet" href="e-constructor2.css" />
  <style>
    /* styles unchanged for brevity */
  </style>
</head>
<body>
  <header><h1>E-constructor</h1></header>
  <nav class="navbar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="make-entries.html">Make Entries</a></li>
      <li><a href="details.html">View Property Details</a></li>
      <li><a href="other.html">Other</a></li>
    </ul>
  </nav>

  <main>
    <!-- M-Pesa Statement Form -->
    <section id="mpesa-statement" class="entry-form">
      <h3>Request M-Pesa Statement</h3>
      <form id="statement-form">
        <label for="id-serial">ID / Serial Number</label><br>
        <input type="text" id="id-serial" required /><br><br>

        <label for="e-pin">E-constructor PIN</label><br>
        <input type="text" id="e-pin" required /><br><br>

        <label for="email">Email Address</label><br>
        <input type="email" id="email" required /><br><br>

        <label for="mpesa-number">M-Pesa Number</label><br>
        <input type="tel" id="mpesa-number" required /><br><br>

        <button type="submit">Request Statement</button>
        <p id="statement-status"></p>
      </form>
    </section>

    <!-- Report Negligence Form -->
    <form id="report-form" class="report-section" enctype="multipart/form-data">
      <h2>Report Landlord Negligence</h2>

      <label for="buildingId">Building LR Number:</label>
      <input type="text" id="buildingId" name="buildingId" required><br><br>

      <label for="issueDescription">Describe the Issue:</label>
      <textarea id="issueDescription" name="issueDescription" required></textarea><br><br>

      <label for="evidence">Upload Photo Evidence:</label>
      <input type="file" id="evidence" name="evidence" accept="image/*" capture="environment" required><br><br>

      <label style="display: block; font-weight: bold;">
        <input type="checkbox" name="spam_warning_ack" required>
        I understand submitting false complaints is a criminal offense.
      </label><br><br>

      <button type="submit" class="btn-report">Submit Report</button>
      <p id="report-status"></p>
    </form>
  </main>

  <script>
    // Handle M-Pesa statement request (placeholder only)
    document.getElementById("statement-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const status = document.getElementById("statement-status");
      status.textContent = "✅ Statement request received. You’ll get it via email shortly.";
      status.style.color = "lightgreen";
    });

    // Report Landlord Negligence
    document.addEventListener("DOMContentLoaded", () => {
      const reportForm = document.getElementById("report-form");

      reportForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const buildingId = reportForm.buildingId.value.trim();
        const description = reportForm.issueDescription.value.trim();
        const file = reportForm.evidence.files[0];
        const statusEl = document.getElementById("report-status");

        if (!buildingId || !description || !file) {
          alert("All fields are required.");
          return;
        }

        reportForm.querySelector("button").disabled = true;
        statusEl.textContent = "⏳ Submitting report...";
        statusEl.style.color = "lightyellow";

        try {
          // Step 1: Report Submission
          const reportRes = await fetch("https://e-constructor2-backend-clean.onrender.com/api/report", {
            method: "POST",
            body: new FormData(reportForm)
          });

          const reportText = await reportRes.text();
          let reportData;

          try {
            reportData = JSON.parse(reportText);
          } catch {
            throw new Error("Report API returned non-JSON:\n" + reportText);
          }

          if (!reportRes.ok) throw new Error(reportData.message || "Report failed");

          // Step 2: Freeze Estimate
          const freezeRes = await fetch(`https://e-constructor2-backend-clean.onrender.com/api/property/freeze-estimate/${buildingId}`);
          const freezeText = await freezeRes.text();

          let freezeData;
          try {
            freezeData = JSON.parse(freezeText);
          } catch {
            throw new Error("Freeze estimate not valid JSON:\n" + freezeText);
          }

          if (!freezeRes.ok) throw new Error(freezeData.message || "Freeze estimate failed");

          const { activeTenants, totalToFreeze } = freezeData;

          // Step 3: Freeze Account
          const freezeReq = await fetch("https://e-constructor2-backend-clean.onrender.com/api/mpesa/freeze-account", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              landlordId: reportData.landlordId || "unknown",
              amount: totalToFreeze,
              reason: `Negligence affecting ${activeTenants} tenant(s)`
            })
          });

          const freezeRespText = await freezeReq.text();
          let freezeResp;

          try {
            freezeResp = JSON.parse(freezeRespText);
          } catch {
            throw new Error("Freeze response not JSON:\n" + freezeRespText);
          }

          if (!freezeReq.ok) throw new Error(freezeResp.message || "Freeze failed");

          // All successful
          alert(`✅ Freeze initiated: KES ${totalToFreeze} for ${activeTenants} tenant(s).`);
          reportForm.reset();
          statusEl.textContent = "";
        } catch (err) {
          console.error("❌", err.message);
          statusEl.textContent = "Error: " + err.message;
          statusEl.style.color = "red";
        } finally {
          reportForm.querySelector("button").disabled = false;
        }
      });
    });
  </script>
</body>
</html>
